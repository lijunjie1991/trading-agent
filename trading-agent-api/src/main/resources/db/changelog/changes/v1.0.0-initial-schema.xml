<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ChangeSet 1: Create users table -->
    <changeSet id="1" author="tradingagent">
        <comment>Create users table</comment>
        <sql>
            CREATE TABLE users (
                id BIGINT AUTO_INCREMENT PRIMARY KEY,
                email VARCHAR(100) NOT NULL UNIQUE,
                password VARCHAR(255) NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP NOT NULL
            );
        </sql>
        <rollback>
            DROP TABLE users;
        </rollback>
    </changeSet>

    <!-- ChangeSet 2: Create tasks table -->
    <changeSet id="2" author="tradingagent">
        <comment>Create tasks table</comment>
        <sql>
            CREATE TABLE tasks (
                id BIGINT AUTO_INCREMENT PRIMARY KEY,
                task_id VARCHAR(36) NOT NULL UNIQUE,
                user_id BIGINT NOT NULL,
                ticker VARCHAR(20) NOT NULL,
                analysis_date DATE NOT NULL,
                selected_analysts TEXT COMMENT 'JSON array of selected analysts',
                research_depth INT DEFAULT 1,
                status VARCHAR(20) DEFAULT 'PENDING',
                final_decision VARCHAR(50),
                error_message TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                completed_at TIMESTAMP NULL
            );
        </sql>
        <rollback>
            DROP TABLE tasks;
        </rollback>
    </changeSet>

    <!-- ChangeSet 3: Add foreign key for tasks.user_id -->
    <changeSet id="3" author="tradingagent">
        <comment>Add foreign key constraint for tasks.user_id</comment>
        <sql>
            ALTER TABLE tasks
                ADD CONSTRAINT fk_tasks_user_id
                FOREIGN KEY (user_id) REFERENCES users(id)
                ON DELETE CASCADE;
        </sql>
        <rollback>
            ALTER TABLE tasks DROP FOREIGN KEY fk_tasks_user_id;
        </rollback>
    </changeSet>

    <!-- ChangeSet 4: Create indexes on tasks table -->
    <changeSet id="4" author="tradingagent">
        <comment>Create indexes on tasks table</comment>
        <sql>
            CREATE INDEX idx_tasks_user_id ON tasks(user_id);
            CREATE INDEX idx_tasks_task_id ON tasks(task_id);
            CREATE INDEX idx_tasks_status ON tasks(status);
        </sql>
        <rollback>
            DROP INDEX idx_tasks_user_id ON tasks;
            DROP INDEX idx_tasks_task_id ON tasks;
            DROP INDEX idx_tasks_status ON tasks;
        </rollback>
    </changeSet>

    <!-- ChangeSet 5: Create reports table -->
    <changeSet id="5" author="tradingagent">
        <comment>Create reports table</comment>
        <sql>
            CREATE TABLE reports (
                id BIGINT AUTO_INCREMENT PRIMARY KEY,
                task_id BIGINT NOT NULL,
                report_type VARCHAR(50) NOT NULL,
                content TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
            );
        </sql>
        <rollback>
            DROP TABLE reports;
        </rollback>
    </changeSet>

    <!-- ChangeSet 6: Add foreign key for reports.task_id -->
    <changeSet id="6" author="tradingagent">
        <comment>Add foreign key constraint for reports.task_id</comment>
        <sql>
            ALTER TABLE reports
                ADD CONSTRAINT fk_reports_task_id
                FOREIGN KEY (task_id) REFERENCES tasks(id)
                ON DELETE CASCADE;
        </sql>
        <rollback>
            ALTER TABLE reports DROP FOREIGN KEY fk_reports_task_id;
        </rollback>
    </changeSet>

    <!-- ChangeSet 7: Create index on reports.task_id -->
    <changeSet id="7" author="tradingagent">
        <comment>Create index on reports.task_id</comment>
        <sql>
            CREATE INDEX idx_reports_task_id ON reports(task_id);
        </sql>
        <rollback>
            DROP INDEX idx_reports_task_id ON reports;
        </rollback>
    </changeSet>

</databaseChangeLog>
