# 收费功能开发设计方案

本文档在现有 TradingAgents 项目（`trading-agent-api`、`trading-agent-engine`、`trading-agent-ui`）基础上，给出收费功能的详细设计与改造计划。目标是集成 Stripe 付费，支持新用户免费额度、按需收费、支付完成后再触发 Python 分析流程。

## 1. 信息与配置需求

- **Stripe 账户与密钥**
  - Publishable Key（前端使用）
  - Secret Key（后端调用 Stripe API）
  - Webhook Signing Secret（校验 Stripe 事件）
  - 支持的货币（建议 `usd`）
  - 支付成功/取消跳转 URL
- **价格配置**（示例默认值，可在数据库或配置文件中维护）

  | 配置项             | 示例值        | 说明                                                         |
  |--------------------|---------------|--------------------------------------------------------------|
  | 免费任务数量       | 5             | 新用户初始可配置额度，写入 `user_quotas.free_tasks_total`       |
  | 基础价格（美元）   | 10.00         | 深度为 1 且仅选择 1 名分析师时的基准费用                     |
  | Depth 倍率         | 1 → 1.0<br>2 → 1.5<br>3 → 2.0<br>4 → 2.5<br>5 → 3.0 | 深度越高费用越高，由 `pricing_strategy` 表维护                |
  | Analysts 倍率      | 1 名 → 1.0<br>2 名 → 1.3<br>3 名 → 1.6<br>4 名 → 1.9 | 每增加分析师按倍数加价，同由 `pricing_strategy` 表维护       |
  | 其他附加项         | 视需求配置    | 例如税费、加急费，可在 `pricing_strategy` 表追加字段或 JSON 扩展 |
- **环境变量**
  - 后端：`STRIPE_SECRET_KEY`、`STRIPE_WEBHOOK_SECRET`、`FREE_TASK_LIMIT`、`PRICING_BASE_AMOUNT_USD` 等
  - 前端：`VITE_STRIPE_PUBLISHABLE_KEY`、`VITE_API_BASE_URL`
  - Python 引擎：保持现有数据库连接变量；若新增字段需同步
- **Webhook 部署**
  - HTTPS 域名、证书
  - 本地联调可使用 `stripe cli` 隧道映射
- **合规要求**
  - 是否需要持久化发票链接、退款记录、导出报表
  - 内部审计需要的日志内容（需脱敏）

## 2. 业务流程概述

1. **免费额度**
   - 用户注册 (`AuthService.register`) 后创建额度记录（默认可配置，例如 5 个）
   - 若当前用户的免费额度尚有余额，任务直接按原流程执行：创建任务后调用 Python 引擎
2. **付费任务**
   - 免费额度耗尽后，`POST /api/v1/tasks` 先计算价格并创建待付款任务
   - 任务状态设置为 `WAITING_PAYMENT`，记录 `amount_cents`、`payment_intent_id` 及定价策略快照
   - 返回 Stripe `client_secret`、金额、支付状态给前端；此时不推送到 Python
   - 前端调用 Stripe Elements 完成支付；支付成功事件通过 webhook 或前端确认接口通知后端
   - 后端校验支付成功后，更新任务状态为 `PENDING`，记录 `paid_at`，调用 Python 引擎进入分析
3. **状态机**
   - `Task.paymentStatus`：`FREE_GRANTED`、`WAITING_PAYMENT`、`PROCESSING`、`PAID`、`FAILED`、`REFUNDED`
   - `Task.status` 扩展 `WAITING_PAYMENT`、`PAYMENT_FAILED`，兼容现有 `PENDING/RUNNING/COMPLETED/FAILED`
4. **补偿机制**
   - Webhook 失败时写入重试日志，后台定时任务扫描 `payments` 表中长时间 `PROCESSING` 的记录，调用 Stripe 查询补偿

## 3. 数据库改造（Liquibase）

### 3.1 修改 `tasks` 表

新建变更文件 `db/changelog/changes/v1.2.0-billing.xml`，内容包括：

```sql
ALTER TABLE tasks
    ADD COLUMN payment_status VARCHAR(30) DEFAULT 'FREE_GRANTED',
    ADD COLUMN payment_intent_id VARCHAR(255),
    ADD COLUMN amount_cents INT DEFAULT 0,
    ADD COLUMN currency VARCHAR(10) DEFAULT 'usd',
    ADD COLUMN pricing_strategy_code VARCHAR(50),
    ADD COLUMN pricing_snapshot JSON NULL,
    ADD COLUMN charge_type VARCHAR(20) DEFAULT 'FREE',
    ADD COLUMN paid_at TIMESTAMP NULL,
    ADD COLUMN queued_at TIMESTAMP NULL;
```

> 推荐为 `pricing_strategy_code` 建立索引，或在需要时转为外键（`pricing_strategy.id`），并在任务记录中同时保存定价快照以保证历史可追溯。

### 3.2 新建 `user_quotas` 表

```sql
CREATE TABLE user_quotas (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL UNIQUE,
    free_tasks_total INT NOT NULL DEFAULT 5,
    free_tasks_used INT NOT NULL DEFAULT 0,
    paid_tasks_total INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT fk_user_quotas_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 3.3 新建 `payments` 表

```sql
CREATE TABLE payments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    payment_intent_id VARCHAR(255) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    task_id BIGINT NOT NULL,
    amount_cents INT NOT NULL,
    currency VARCHAR(10) NOT NULL DEFAULT 'usd',
    pricing_strategy_code VARCHAR(50),
    status VARCHAR(30) NOT NULL DEFAULT 'WAITING_PAYMENT',
    payment_method VARCHAR(100),
    receipt_url VARCHAR(1024),
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT fk_payments_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_payments_task FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
    INDEX idx_payments_status (status)
);
```

### 3.4 新建 `pricing_strategy` 表

用于集中维护收费策略，满足“免费任务数量、基础价格、Depth 倍率、Analysts 倍率”四类核心字段，并支持多套策略切换：

```sql
CREATE TABLE pricing_strategy (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    strategy_code VARCHAR(50) NOT NULL UNIQUE,
    description VARCHAR(255),
    free_task_quota INT NOT NULL DEFAULT 5,
    base_price_cents INT NOT NULL,
    depth_multiplier JSON NOT NULL COMMENT '{"1":1.0,"2":1.5,"3":2.0,"4":2.5,"5":3.0}',
    analyst_multiplier JSON NOT NULL COMMENT '{"1":1.0,"2":1.3,"3":1.6,"4":1.9}',
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

> JSON 字段可根据需要扩展，例如加入税费、加急费等附加配置。

### 3.5 Python ORM 同步

`trading-agent-engine/api/database.py` 中的 SQLAlchemy 模型需新增上述字段，保持与 Java 实体一致。

## 4. 后端（Spring Boot）改造

- **实体与 DTO**
  - 更新 `Task` 实体 (`trading-agent-api/.../entity/Task.java`) 增加支付字段
  - 新增 `Payment`、`UserQuota` 实体及对应 Repository
  - 扩展 `TaskResponse` (`.../dto/TaskResponse.java`) 返回 `paymentStatus`、`amountCents`、`currency`、`chargeType`、`pricingSnapshot`
  - `TaskRequest` 可增加 `couponCode`、`clientReferenceId`、`riskDisclosureAccepted`

- **服务层**
  - 新增 `PricingService`：从 `pricing_strategy` 表读取策略（可缓存），计算金额与明细并生成 `pricingSnapshot`
  - 新增 `QuotaService`：注册时初始化额度，在任务提交时扣减免费额度，需加事务
  - 新增 `StripePaymentService`：封装 Stripe SDK 调用（创建 PaymentIntent、查询、处理事件、退款）
  - 新增 `TaskExecutionService`：统一负责支付成功后的任务触发，调用 `PythonServiceClient.submitAnalysisTask`
  - 重构现有 `TaskService.submitTask`：
    - 查询额度；若仍有免费额度：
      - 走现有逻辑（立即调用 Python）
      - 更新 `user_quotas.free_tasks_used`
      - `payment_status=FREE_GRANTED`
    - 若需要付费：
      - 创建任务记录，设置 `status=WAITING_PAYMENT`，写入当前启用的 `pricing_strategy_code` 与 `pricing_snapshot`
      - 调用 `StripePaymentService.createPaymentIntent`，写入 `payments` 记录并保存定价快照
      - 返回任务和支付信息，不调用 Python

- **控制器**
  - `POST /api/v1/tasks` 返回结构调整，包含支付信息
  - 新增 `BillingController`：
    - `GET /api/v1/billing/profile`：返回免费额度、历史消费概览
    - `POST /api/v1/tasks/price-quote`：实时获取报价供前端展示
  - 新增 `PaymentController`：
    - `POST /api/v1/payments/confirm`：前端支付成功后主动通知，后端复核 PaymentIntent
    - `POST /api/v1/payments/stripe/webhook`：处理 Stripe 事件（需校验签名）
    - 可选：`POST /api/v1/payments/{taskId}/retry` 重新生成 PaymentIntent

- **配置与安全**
  - `application.yml` 增加 `stripe.*`、`billing.*` 节点
  - Spring Security 放宽 webhook 路径匿名访问，同时校验签名
  - 记录支付日志（脱敏），便于审计与排错

- **并发与事务**
  - `TaskService.submitTask` 使用 `@Transactional`，确保任务、额度、支付记录一致
  - Stripe 事件处理时，幂等校验 `payment_intent_id`，避免重复触发

## 5. Python 引擎改造

- `TaskStatus` 枚举允许 `WAITING_PAYMENT`、`PAYMENT_FAILED`，避免未知状态报错
- `api/db_service.py` 中的 `update_task_status` 接受新的状态值，保持大写存储
- 可选：在启动队列或定时任务中支持读取 `queued_at` 字段，以后扩展排队机制
- 若任务重复触发需要幂等校验（例如状态已是 `RUNNING/COMPLETED` 时不再执行）

## 6. 前端（React + Ant Design）改造

- **环境与依赖**
  - 新增 `@stripe/stripe-js`、`@stripe/react-stripe-js`
  - 在 `src/main.jsx` 初始化 Stripe Provider（使用 `VITE_STRIPE_PUBLISHABLE_KEY`）

- **状态管理**
  - 扩展 `taskSlice` (`src/store/slices/taskSlice.js`)
    - `startAnalysis` thunk 处理后端返回的 `payment` 信息
    - 新增字段保存 `clientSecret`、支付金额等
  - 可新增 `billingSlice` 管理额度、支付状态
  - 在任务详情、列表中展示 `paymentStatus`

- **界面调整**
  - `TaskForm.jsx` 增加费用预估（调用 `POST /api/v1/tasks/price-quote` 或前端计算）
  - 新增 `TaskCheckout` 组件/页面：加载 Stripe Elements，显示订单摘要、剩余免费额度、支付按钮
  - 支付成功后显示提示“已付款，任务排队中”，再跳转任务详情
  - `Dashboard.jsx` 展示免费额度信息
  - `TaskDetail.jsx` 显示支付金额、收据链接、支付状态

- **错误处理**
  - 处理 `WAITING_PAYMENT`、`PAYMENT_FAILED` 状态对应的提示与重试按钮
  - 配合后端 `retry` 接口允许重新发起付款

## 7. API 接口定义

| 方法 | 路径 | 描述 |
| ---- | ---- | ---- |
| `POST` | `/api/v1/tasks` | 创建任务；根据免费/付费返回不同响应 |
| `POST` | `/api/v1/tasks/price-quote` | 获取价格报价 |
| `GET` | `/api/v1/billing/profile` | 获取用户额度与消费信息 |
| `POST` | `/api/v1/payments/confirm` | 前端回调后确认支付并触发任务 |
| `POST` | `/api/v1/payments/stripe/webhook` | 接收 Stripe Webhook |
| `POST` | `/api/v1/payments/{taskId}/retry` | （可选）重新生成 PaymentIntent |

### 7.1 `POST /api/v1/tasks` 响应示例

```json
{
  "code": 0,
  "message": "Task created",
  "data": {
    "taskId": "7f816c7d-...",
    "status": "WAITING_PAYMENT",
    "payment": {
      "required": true,
      "paymentIntentId": "pi_3Nv...",
      "clientSecret": "pi_3Nv..._secret_...",
      "amountCents": 3500,
      "currency": "usd",
      "pricingStrategyCode": "DEFAULT_2024",
      "pricingSnapshot": {
        "base": 1000,
        "depthMultiplier": 2.0,
        "analystCount": 3,
        "analystAddon": 900
      }
    }
  }
}
```

若免费额度可用：

```json
{
  "code": 0,
  "message": "Task submitted successfully",
  "data": {
    "taskId": "ec34...",
    "status": "PENDING",
    "payment": {
      "required": false,
      "freeQuotaConsumed": true,
      "freeTasksRemaining": 4,
      "pricingStrategyCode": "DEFAULT_2024"
    }
  }
}
```

## 8. 安全与合规注意事项

- Webhook 必须验证 `Stripe-Signature`，对请求体、事件 ID 做幂等性检查
- 记录 Stripe Request ID 与 PaymentIntent ID，日志脱敏处理（只保留卡号后四位）
- 支付日志与额度变更加入审计（谁扣减、扣减多少、结果如何）
- 退款流程：在 `payments.status` 中表示 `REFUNDED`，可提供后台脚本调用 Stripe 退款 API
- 对任务状态/支付状态的修改均需加事务保证原子性

## 9. 开发测试建议

- **单元测试**
  - `PricingService`：覆盖不同深度与分析师组合的金额计算
  - `QuotaService`：并发扣减免费额度，验证事务与锁
  - `StripePaymentService`：使用 Stripe mock 测试 PaymentIntent 创建/查询
- **集成测试**
  - `@SpringBootTest` + WireMock 模拟 Stripe API 响应
  - 测试任务创建时免费与付费两条路径
  - Webhook 事件幂等性验证
- **前端测试**
  - 单元测试报价逻辑
  - Cypress/E2E：覆盖免费提交、付费提交流程
- **监控与报警**
  - 监控支付成功率、失败率、平均金额
  - Webhook 失败或任务未能排队进入 Python 时报警
- **上线顺序**
  1. 先部署数据库变更
  2. 发布后端（兼容旧前端）
  3. 更新 Python ORM（若需要）
  4. 最后上线前端
  5. 上线前在 Stripe Dashboard 测试模式验证支付与回调

## 10. 后续扩展

- 订阅或套餐（例如按月包期），可在 `payments` 表新增类型字段
- 后台管理界面：调整价格、查看支付报表、手动补偿
- 更细粒度的使用记录表（存储每次扣费的明细、分析耗时等）
- 增加 Promo Code / Coupon 功能

以上设计确保满足“Stripe 收费”、“免费额度 5 个可配置”、“超出后按 Research Depth + Analysts 计费”、“支付成功后再提交 Python 分析”的业务需求。

## 11. 实施任务拆解（TODO List）

### 阶段一：设计确认与准备
- [ ] 审核并冻结 `pricing_strategy` 表字段及默认策略数据
- [ ] 确认 Stripe 账户、产品、Webhook 域名等配置信息
- [ ] 输出收费流程原型及前端 UI 设计稿
- [ ] 明确测试方案（单元、集成、E2E）与验收标准

### 阶段二：数据库与基础配置
- [x] 添加 Stripe/Billing 配置占位符（`application*.yml`、根 `.env`、前端 `.env.example`）
- [x] 编写 Liquibase 变更脚本（`tasks`、`user_quotas`、`payments`、`pricing_strategy`）
- [x] 准备 `pricing_strategy` 默认数据脚本或初始化逻辑
- [ ] 更新 Python ORM（`api/database.py`）同步新增字段（当前业务无需求，可后续再补）
- [ ] 在开发/测试环境执行数据库迁移并验证

### 阶段三：后端开发（Spring Boot）
- [x] 创建 `PricingStrategy`、`Payment`, `UserQuota` 实体与 Repository
- [x] 实现 `PricingService`（读取策略、缓存、金额计算）
- [x] 实现 `QuotaService`（注册初始化、额度扣减、事务控制）
- [x] 集成 Stripe SDK，封装 `StripePaymentService`
- [x] 新建 `TaskExecutionService`，负责支付成功后的任务提交
- [x] 重构 `TaskService.submitTask`，处理免费/付费分支与策略快照
- [x] 新增 Billing / Payment API（Billing 功能合并到 `TaskController`，新增 `PaymentController`）
- [x] 更新 `TaskController` 响应结构以含支付信息
- [x] 配置 Spring Security 放行 webhook 并做好签名校验
- [ ] 编写相关单元测试/集成测试

### 阶段四：Python 引擎改造
- [ ] 更新 `TaskStatus` 定义，兼容 `WAITING_PAYMENT` 等新状态（用户确认当前阶段可暂不修改）
- [ ] 调整 `db_service.py`，确保新增字段读写无误（同上暂缓）
- [ ] 验证支付后触发流程的幂等性与状态更新

### 阶段五：前端开发（React）
- [x] 引入 Stripe 依赖并在支付流程中初始化 Elements
- [x] 扩展 Redux `taskSlice`，支持支付上下文、额度信息、价格试算
- [x] 改造 `TaskForm`，展示费用预估与免费额度提示
- [x] 新增 `TaskCheckout` 模块，处理 Stripe 支付流程
- [x] 调整任务列表/详情页显示支付状态、金额、收据
- [x] 接入新的 API（price-quote、billing profile、payments confirm）
- [ ] 编写前端单元与端到端测试

### 阶段六：联调与验收
- [ ] 本地/测试环境联调 Stripe （使用测试卡）
- [ ] 验证免费额度、付费、支付失败、重试、Webhook 补偿等场景
- [ ] 校验日志、审计、监控指标是否符合要求
- [ ] 运行全部自动化测试并修复问题

### 阶段七：上线准备与运维
- [ ] 编写上线步骤（数据库迁移 → 后端 → Python → 前端）
- [ ] 配置生产环境 Stripe 密钥与回调地址
- [ ] 设置监控与报警（支付成功率、Webhook 失败率等）
- [ ] 准备回滚方案（数据库备份、功能开关）
- [ ] 上线后观察关键指标并完成验收报告
